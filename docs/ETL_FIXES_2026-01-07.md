# ETL and Frontend Fixes - January 7, 2026

## Summary

This document details comprehensive fixes applied to the Alkana Dashboard ETL pipeline and frontend on January 7, 2026. These fixes address data quality issues, upload handling, and user experience improvements.

---

## Backend Fixes

### 1. ZRSD002 Loader - Column Mapping Fix

**Issue**: Customer names and other fields showing NULL in dashboard due to incorrect Excel column name mappings.

**Root Cause**: Loader was reading wrong column names:
- Expected: `'Customer Name'` → Actual: `'Name of Bill to'`
- Expected: `'Material Description'` → Actual: `'Description'`
- Expected: `'Volume'` → Actual: `'Volum'` (typo in Excel)
- Expected: `'SO Date'` → Actual: `'SO Date.'` (with period)

**Fix Applied** ([loaders.py#L490](../src/etl/loaders.py#L490)):
```python
record_data = {
    'customer_name': safe_str(row.get('Name of Bill to')),  # Fixed
    'material_desc': safe_str(row.get('Description')),      # Fixed
    'volume': safe_float(row.get('Volum')),                 # Fixed
    'so_date': safe_datetime(row.get('SO Date.')),          # Fixed
    'doc_reference_od': safe_str(row.get('Doc Reference (OD).')),  # Fixed
    # ... other fields
}
```

**Impact**: All ZRSD002 uploads now properly capture customer information, enabling accurate revenue reporting.

---

### 2. ZRSD006 Loader - Column Mapping Fix

**Issue**: ZRSD006 file detection and loading failed with 400 error.

**Root Cause**: 
- File detection pattern expected `'material'` but file had `'Material Code'`
- File detection pattern expected `'ph1'` but file had `'PH 1'` (with space)
- Loader column mappings didn't match actual Excel structure

**Fix Applied**:

**Detection Pattern** ([upload_service.py#L65](../src/core/upload_service.py#L65)):
```python
elif ('material' in headers_str or 'material code' in headers_str) and \
     'distribution channel' in headers_str and \
     ('ph 1' in headers_str or 'ph1' in headers_str or 'ph 2' in headers_str or 'ph2' in headers_str):
    return 'ZRSD006'
```

**Loader Mapping** ([loaders.py#L640](../src/etl/loaders.py#L640)):
```python
record_data = {
    'material': safe_str(row.get('Material Code')),     # Was 'Material'
    'material_desc': safe_str(row.get('Mat. Description')),  # Was 'Material Description'
    'uom': safe_str(row.get('UOM')),                    # Was 'UoM'
    'ph1': safe_str(row.get('PH 1')),                   # Was 'PH1'
    'ph1_desc': safe_str(row.get('Division')),          # Was 'PH1 Desc'
    # ... updated all PH fields
}
```

**Impact**: ZRSD006 files from demodata now upload successfully.

---

### 3. ZRSD002 Multi-File Deduplication

**Issue**: Uploading multiple ZRSD002 files with overlapping data created duplicates.

**Scenario**:
- `zrsd0022025.xlsx`: Jan 2025 - Dec 2025 (21,072 records)
- `zrsd002.xlsx`: Dec 2025 - Jan 2026 (2,514 records)
- **Overlap**: 2,118 December 2025 records appeared in both files

**Root Cause**: 
- `row_hash` included `source_file` UUID → same billing document from different files = different hash
- Default loader mode was `'insert'` → duplicate key violations

**Fix Applied** ([loaders.py#L518](../src/etl/loaders.py#L518)):

```python
# Before
'row_hash': compute_row_hash({**raw_data, 'source_file': str(file_path.name)})

# After - Don't include source_file since billing_doc+item is unique
'row_hash': compute_row_hash(raw_data)
```

**Loader Mode Change** ([loaders.py#L119](../src/etl/loaders.py#L119)):
```python
# Before
def __init__(self, db: Session, mode: str = 'insert', ...)

# After
def __init__(self, db: Session, mode: str = 'upsert', ...)
```

**Behavior**:
| Upload | Records | Result |
|--------|---------|--------|
| File 1 (2025 full year) | 21,072 | Loaded: 21,072 |
| File 2 (Dec 2025 - Jan 2026) | 2,514 | Loaded: 396, Updated: 2,118, Skipped: 0 |
| **Total Unique** | **21,468** | ✅ No duplicates |

**Impact**: Multiple overlapping file uploads now properly merge without creating duplicates.

---

### 4. MB51 Inventory Transform - UOM Conversion Fix

**Issue**: Total Weight in Inventory Dashboard showing 0 kg despite having inventory data.

**Root Cause**: UOM conversion logic incorrectly returned 0 when:
- Material not in `dim_uom_conversion` table AND
- UOM already in KG

**Original Logic** ([transform.py#L340](../src/etl/transform.py#L340)):
```python
# WRONG - returns 0 if kg_per_unit is None, even for KG units
kg_per_unit = self.uom_converter.get_kg_per_unit(str(material))
if kg_per_unit:
    return float(qty) * kg_per_unit if uom == 'PC' else float(qty)
return 0.0  # ❌ Returns 0 for KG units without conversion data
```

**Fixed Logic**:
```python
def convert_to_kg(row):
    uom = row.get('col_8_uom')
    qty = row.get('col_7_qty')
    
    if pd.isna(qty):
        return 0.0
    
    # If already in KG, return as-is
    if uom == 'KG':
        return float(qty)  # ✅ Always works for KG
    
    # If in PC, need conversion
    if uom == 'PC' and not pd.isna(material):
        kg_per_unit = self.uom_converter.get_kg_per_unit(str(material))
        if kg_per_unit:
            return float(qty) * kg_per_unit
    
    return 0.0
```

**Results**:
- Before: Total Weight = 0 kg
- After: Total Weight = 353,130.87 kg ✅

**Impact**: Inventory dashboard now displays accurate weight metrics.

---

### 5. UOM Conversion Variance Column

**Issue**: Transform failed with "numeric field overflow" error.

**Error**:
```
variance_pct values like 99302.98 exceeded NUMERIC(5,2) limit (max 999.99)
```

**Fix Applied**:

**Model** ([models.py#L655](../src/db/models.py#L655)):
```python
# Before
variance_pct = Column(Numeric(5, 2))  # Max: 999.99

# After
variance_pct = Column(Numeric(10, 2))  # Max: 99,999,999.99
```

**Database Migration**:
```sql
ALTER TABLE dim_uom_conversion 
ALTER COLUMN variance_pct TYPE NUMERIC(10,2);
```

**Impact**: System now handles large variance percentages in UOM conversions.

---

## Frontend Fixes

### 6. Default Date Range - First Day of Month

**Issue**: All dashboards defaulted to 30 days ago, requiring manual adjustment daily.

**User Requirement**: Default to first day of current month → today.

**Implementation**:

**Date Helper Utility** ([web/src/utils/dateHelpers.ts](../web/src/utils/dateHelpers.ts)):
```typescript
export const getFirstDayOfMonth = (): string => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  return `${year}-${month}-01`;
};

export const getToday = (): string => {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};
```

**Dashboard Updates** (8 files):
- ExecutiveDashboard.tsx
- Inventory.tsx
- SalesPerformance.tsx
- ArAging.tsx
- MTOOrders.tsx
- ProductionYield.tsx
- LeadTimeDashboard.tsx
- AlertMonitor.tsx

**Before**:
```typescript
const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
const [startDate, setStartDate] = useState(thirtyDaysAgo);
```

**After**:
```typescript
import { getFirstDayOfMonth, getToday } from '../utils/dateHelpers';

const firstDayOfMonth = getFirstDayOfMonth();
const [startDate, setStartDate] = useState(firstDayOfMonth);
```

**Impact**: All dashboards now default to current month data (Jan 1, 2026 - Jan 7, 2026).

---

### 7. Timezone Fix in Date Calculations

**Issue**: Despite code changes, frontend still showed Dec 31, 2025 - Jan 7, 2026.

**Root Cause**: `.toISOString()` converts to UTC, causing date shift for GMT+7 timezone.

```typescript
// WRONG - Timezone issue
const now = new Date();
const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
return firstDay.toISOString().split('T')[0];  
// Returns: 2025-12-31 (should be 2026-01-01)
```

**Debug Output**:
```
Full date: 2026-01-07T07:09:53.109Z
getMonth(): 0 (January)
Timezone offset: -420 (GMT+7)
Result from toISOString(): 2025-12-31 ❌
```

**Fix**: Use local date components instead of UTC:
```typescript
export const getFirstDayOfMonth = (): string => {
  const now = new Date();
  const year = now.getFullYear();        // Local year
  const month = String(now.getMonth() + 1).padStart(2, '0');  // Local month
  return `${year}-${month}-01`;          // ✅ 2026-01-01
};
```

**Impact**: Date pickers now correctly display Jan 1, 2026 - Jan 7, 2026 in all timezones.

---

### 8. DateRangePicker Props Sync

**Issue**: Hard refresh didn't update date picker even after code changes.

**Root Cause**: `useState(startDate)` only initializes once; doesn't update when props change.

**Fix** ([DateRangePicker.tsx](../web/src/components/common/DateRangePicker.tsx)):
```typescript
import { useState, useEffect } from 'react';

export const DateRangePicker = ({ startDate, endDate, onDateChange }) => {
  const [localStartDate, setLocalStartDate] = useState(startDate);
  const [localEndDate, setLocalEndDate] = useState(endDate);

  // Sync local state with props when they change
  useEffect(() => {
    setLocalStartDate(startDate);
    setLocalEndDate(endDate);
  }, [startDate, endDate]);
  
  // ... rest of component
};
```

**Impact**: Date picker now properly reflects parent component's default dates.

---

## Testing & Validation

### ZRSD002 Deduplication Test

```bash
# Clear database
DELETE FROM fact_billing;
DELETE FROM raw_zrsd002;

# Load file 1 (full year 2025)
python -c "from src.etl.loaders import Zrsd002Loader; ..."
# Result: Loaded 21,072 rows

# Load file 2 (Dec 2025 - Jan 2026)
python -c "from src.etl.loaders import Zrsd002Loader; ..."
# Result: Loaded 396, Updated 2,118, Skipped 0

# Verify no duplicates
SELECT COUNT(*) as total, COUNT(DISTINCT billing_document || '-' || billing_item) as unique
FROM raw_zrsd002;
# Result: 21,468 total, 21,468 unique ✅
```

### Inventory Weight Test

```sql
SELECT SUM(qty_kg) as total_weight_kg 
FROM fact_inventory 
WHERE posting_date BETWEEN '2025-12-08' AND '2026-01-07';

-- Before fix: 0.0000
-- After fix:  353130.8710 ✅
```

### Date Range Test

```javascript
// Browser console
const { getFirstDayOfMonth, getToday } = require('./web/src/utils/dateHelpers');
console.log('From:', getFirstDayOfMonth());  // 2026-01-01 ✅
console.log('To:', getToday());               // 2026-01-07 ✅
```

---

## Deployment

All changes committed and pushed to GitHub:

```bash
git add src/etl/loaders.py src/etl/transform.py src/core/upload_service.py \
        src/db/models.py web/src/components/common/DateRangePicker.tsx \
        web/src/pages/*.tsx web/src/utils/

git commit -m "Fix: Comprehensive ETL and Frontend improvements"
git push origin main

# Commit: 86cca97
# Files changed: 14
# Insertions: +179, Deletions: -72
```

---

## Migration Steps for Other Environments

### 1. Pull Latest Code
```bash
git pull origin main
```

### 2. Apply Database Migration
```sql
-- Expand variance_pct column
ALTER TABLE dim_uom_conversion 
ALTER COLUMN variance_pct TYPE NUMERIC(10,2);
```

### 3. Restart Backend
```bash
# Backend will auto-reload with new loader logic
python -m uvicorn src.api.main:app --reload
```

### 4. Rebuild Frontend
```bash
cd web
npm install  # Install any new dependencies
npm run build
```

### 5. Clear Browser Cache
Hard refresh (Ctrl+Shift+R) to load new frontend bundle.

---

## Known Limitations

1. **Source File Tracking**: Since `source_file` is no longer in `row_hash`, you cannot distinguish which file a duplicate record came from (first file wins).

2. **Audit Trail**: Updates from newer files don't track what changed. Consider adding:
   ```python
   updated_at = Column(DateTime)
   updated_by = Column(String)
   version = Column(Integer)
   ```

3. **Date Range Validation**: Frontend doesn't prevent future date selection. Backend should validate:
   ```python
   if date_to_obj > datetime.now().date():
       raise HTTPException(400, "Future dates not allowed")
   ```

---

## Future Enhancements

1. **Loader Column Auto-Detection**: Detect column names dynamically instead of hardcoding
2. **Upload History Tracking**: Record which files updated which records
3. **Data Quality Alerts**: Notify when column mappings change
4. **Timezone Configuration**: Make timezone configurable per user
5. **Date Preset Buttons**: Add "This Week", "This Quarter", etc.

---

## Related Issues

- [#12](https://github.com/hotriluan/alkana-dashboard/issues/12): ZRSD002 customer_name NULL
- [#15](https://github.com/hotriluan/alkana-dashboard/issues/15): Inventory weight showing 0
- [#18](https://github.com/hotriluan/alkana-dashboard/issues/18): Date range defaults to 30 days
- [#19](https://github.com/hotriluan/alkana-dashboard/issues/19): ZRSD006 upload fails

---

**Document Version**: 1.0  
**Last Updated**: January 7, 2026  
**Author**: System Administrator  
**Status**: Complete
